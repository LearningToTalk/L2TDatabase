---
title: "Comparison of word recognition performance in native versus unfamiliar dialects for preschool age children"
author: "Tristan Mahr"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup, include = FALSE, message = FALSE, warning = FALSE, results = 'hide'}
library("knitr")
opts_chunk$set(
  warning = FALSE,
  collapse = TRUE, 
  comment = "#>", 
  message = FALSE,
  fig.width = 8,
  fig.height = 6,
  dpi = 300,
  out.width = "80%")

wd <- rprojroot::find_rstudio_root_file()
opts_knit$set(root.dir = wd)
```

## Problem statement

ME would like to look at the data for the RWL task for participants in the
Dialect Switch study. I will wrangle and reduce the eyetracking data from these
studies.


## Find the eyetracking blocks

Connect to database:

```{r, eval = FALSE}
library(dplyr)
library(L2TDatabase)

# Work relative to RStudio project
wd <- rprojroot::find_rstudio_root_file()
dir_here <- file.path(wd, "inst", "analyses", "ci_matching")
cnf_file <- file.path(wd, "inst", "l2t_db.cnf")

# Connect to the individual databases
l2t_main <- l2t_connect(cnf_file, "l2t")
l2t_backend <- l2t_connect(cnf_file, "backend")
l2t_eyetracking <- l2t_connect(cnf_file, "eyetracking")
```



### Sidetracked: Figure out a way to tell which blocks used the re-recorded stimuli

JE says that we should only use the experiments that used the re-recorded
stimuli for TimePoint2.

```{r}
# Get the audio information from trial attributes
rwl_trials_attrs <- tbl(l2t_eyetracking, "q_TrialAttributesByStudy") %>% 
  filter(Task == "RWL", TrialAttribute_Name %in% c("Audio", "TargetEnd")) %>% 
  collect(n = Inf)

# Figure out the stimuli used for TP1, TP2, TP3
target_lengths <- rwl_trials_attrs %>% 
  tidyr::spread(TrialAttribute_Name, TrialAttribute_Value) %>% 
  select(Study, Audio, TargetEnd) %>% 
  distinct() %>% 
  na.omit() %>% 
  mutate(Dialect = substr(Audio, 1, 3)) %>% 
  select(Study, Dialect, Audio, TargetEnd) %>% 
  filter(Study %in% c("TimePoint1", "TimePoint2", "TimePoint3"))

# It looks like TP1 SAE was uniformly 816 ms and 567 ms in AAE. Label blocks by
# the StimSet used
block_stim <- rwl_trials_attrs %>% 
  tidyr::spread(TrialAttribute_Name, TrialAttribute_Value) %>% 
  select(BlockID, TrialID, Study, Audio, TargetEnd) %>% 
  na.omit() %>% 
  mutate(Dialect = substr(Audio, 1, 3)) %>% 
  group_by(BlockID) %>% 
  mutate(StimSet = ifelse(Dialect == "SAE" & all(TargetEnd == 816), 
                          "TP1", "Not TP1"), 
         StimSet = ifelse(Dialect == "AAE" & all(TargetEnd == 567), 
                          "TP1", StimSet)) %>% 
  ungroup() %>% 
  select(BlockID, Study, Dialect, StimSet) %>% 
  distinct()

# Check that dialect switch got 2 different sets of stimuli
block_stim %>% 
  filter(Study == "DialectSwitch") %>% 
  count(Dialect, StimSet) %>% 
  rename(nBlocks = n) %>% 
  ungroup()

trial_stim %>% 
  filter(Study == "MaternalEd") %>% 
  count(Dialect, StimSet) %>% 
  rename(nBlocks = n) %>% 
  ungroup()
```


Now we can identify which blocks got TP2 versions of the RWL experiment.


Download the records for the blocks of the RWL experiment.

```{r, eval = FALSE}
# Get the dialects of each block from the table of block attributes
block_dialects <- tbl(l2t_eyetracking, "BlockAttributes") %>% 
  select(-BlockAttributeID, -BlockAttribute_Timestamp) %>% 
  collect() %>% 
  # Convert from long to wide format
  tidyr::spread(BlockAttribute_Name, BlockAttribute_Value) %>% 
  select(BlockID, Dialect)

# Get the block information (child, date, filename) for the RWL task
rwl_blocks <- tbl(l2t_eyetracking, "Blocks") %>% 
  select(-Block_Timestamp) %>% 
  filter(Block_Task == "RWL") %>% 
  collect() %>% 
  inner_join(block_dialects) %>% 
  left_join(block_stim)
rwl_blocks
```

Attach research IDs and study names to the blocks.

```{r, eval = FALSE}
child_info <- tbl(l2t_backend, "Child") %>% 
  left_join(tbl(l2t_backend, "ChildStudy")) %>% 
  left_join(tbl(l2t_backend, "Study")) %>% 
  select(Study, ShortResearchID, ChildID, HouseholdID, ChildStudyID, 
         Female, AAE, LateTalker, CImplant) %>% 
  collect()
child_info
```

```{r}
rwl_blocks %>% left_join(child_info)




rwl_looks <- tbl(l2t_eyetracking, "Looks") %>% 
  select(TrialID, Time, GazeByImageAOI) %>% 
  collect(n = Inf)


# Get trials

# Get trial attributes

# Get blocks
```



```{r}

```














