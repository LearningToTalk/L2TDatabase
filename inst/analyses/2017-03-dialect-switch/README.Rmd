---
title: "Comparison of word recognition performance in native versus unfamiliar dialects for preschool age children"
author: "Tristan Mahr"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup, include = FALSE, message = FALSE, warning = FALSE, results = 'hide'}
library("knitr")
opts_chunk$set(
  warning = FALSE,
  collapse = TRUE, 
  comment = "#>", 
  message = FALSE,
  fig.width = 8,
  fig.height = 6,
  dpi = 300,
  out.width = "80%")

wd <- rprojroot::find_rstudio_root_file()
opts_knit$set(root.dir = wd)
```

## Problem statement

ME would like to look at the data for the RWL task for participants in the
Dialect Switch study. I will wrangle and reduce the eyetracking data from these
studies.


## Find the eyetracking blocks

Connect to database:

```{r, eval = FALSE}
library(dplyr)
library(L2TDatabase)

# Work relative to RStudio project
wd <- rprojroot::find_rstudio_root_file()
dir_here <- file.path(wd, "inst", "analyses", "ci_matching")
cnf_file <- file.path(wd, "inst", "l2t_db.cnf")

# Connect to the individual databases
l2t_main <- l2t_connect(cnf_file, "l2t")
l2t_backend <- l2t_connect(cnf_file, "backend")
l2t_eyetracking <- l2t_connect(cnf_file, "eyetracking")
```



### Sidetracked: Figure out a way to tell which blocks used the re-recorded stimuli

JE says that we should only use the experiments that used the re-recorded
stimuli for TimePoint2.

```{r}
# Get the audio information from trial attributes
rwl_trials_attrs <- tbl(l2t_eyetracking, "q_TrialAttributesByStudy") %>% 
  filter(Task == "RWL", TrialAttribute_Name %in% c("Audio", "TargetEnd")) %>% 
  collect(n = Inf)

# Figure out the stimuli used for TP1, TP2, TP3
target_lengths <- rwl_trials_attrs %>% 
  tidyr::spread(TrialAttribute_Name, TrialAttribute_Value) %>% 
  select(Study, Audio, TargetEnd) %>% 
  distinct() %>% 
  na.omit() %>% 
  mutate(Dialect = substr(Audio, 1, 3)) %>% 
  select(Study, Dialect, Audio, TargetEnd) %>% 
  filter(Study %in% c("TimePoint1", "TimePoint2", "TimePoint3"))

# It looks like TP1 SAE was uniformly 816 ms and 567 ms in AAE. Label blocks by
# the StimSet used
block_stim <- rwl_trials_attrs %>% 
  tidyr::spread(TrialAttribute_Name, TrialAttribute_Value) %>% 
  select(BlockID, TrialID, Study, Audio, TargetEnd) %>% 
  na.omit() %>% 
  mutate(Dialect = substr(Audio, 1, 3)) %>% 
  group_by(BlockID) %>% 
  mutate(StimSet = ifelse(Dialect == "SAE" & all(TargetEnd == 816), 
                          "TP1", "Not TP1"), 
         StimSet = ifelse(Dialect == "AAE" & all(TargetEnd == 567), 
                          "TP1", StimSet)) %>% 
  ungroup() %>% 
  select(BlockID, Study, Dialect, StimSet) %>% 
  distinct()

# Check that dialect switch got 2 different sets of stimuli
block_stim %>% 
  filter(Study == "DialectSwitch") %>% 
  count(Dialect, StimSet) %>% 
  rename(nBlocks = n) %>% 
  ungroup()

block_stim %>% 
  filter(Study == "MaternalEd") %>% 
  count(Dialect, StimSet) %>% 
  rename(nBlocks = n) %>% 
  ungroup()
```

Now we can identify which blocks got TP2 versions of the RWL experiment.


Download the records for the blocks of the RWL experiment.

```{r, eval = TRUE}
# Get the dialects of each block from the table of block attributes
block_dialects <- tbl(l2t_eyetracking, "BlockAttributes") %>% 
  select(-BlockAttributeID, -BlockAttribute_Timestamp) %>% 
  collect() %>% 
  # Convert from long to wide format
  tidyr::spread(BlockAttribute_Name, BlockAttribute_Value) %>% 
  select(BlockID, Dialect)

# Get the block information (child, date, filename) for the RWL task
rwl_blocks <- tbl(l2t_eyetracking, "Blocks") %>% 
  select(-Block_Timestamp) %>% 
  filter(Block_Task == "RWL") %>% 
  collect() %>% 
  inner_join(block_dialects) %>% 
  left_join(block_stim)
rwl_blocks
```

Attach research IDs and study names to the blocks.

```{r, eval = FALSE}
child_info <- tbl(l2t_backend, "Child") %>% 
  left_join(tbl(l2t_backend, "ChildStudy")) %>% 
  left_join(tbl(l2t_backend, "Study")) %>% 
  select(Study, ShortResearchID, ChildID, HouseholdID, ChildStudyID, 
         Female, AAE, LateTalker, CImplant) %>% 
  collect()
child_info
```

Now we count the number of dialects presented to each child to find out who
received more than one version of the experiment.

```{r}
tp2_stim_rwl_blocks <- rwl_blocks %>% 
  left_join(child_info) %>% 
  filter(StimSet == "Not TP1") %>% 
  rename(BlockDialect = Dialect)

children_who_got_multiple_dialects <- tp2_stim_rwl_blocks %>% 
  select(ChildID, AAE, BlockDialect) %>% 
  distinct() %>% 
  # Count the dialects presented to each child
  count(AAE, ChildID) %>% 
  filter(n > 1) %>% 
  ungroup() %>% 
  select(ChildID)

blocks_to_keep <- tp2_stim_rwl_blocks %>% 
  inner_join(children_who_got_multiple_dialects) %>% 
  filter(Study %in% c("DialectSwitch", "MaternalEd")) %>% 
  select(Study, ResearchID = ShortResearchID, BlockDialect, Block_Age,
         BlockID, ChildID:CImplant)
```


Now, we need to get the eyetracking data.

```{r}
# Download the trial id's
rwl_trials <- tbl(l2t_eyetracking, "q_TrialsByStudy") %>% 
  filter(Task == "RWL") %>% 
  collect()

# Download the gazes
rwl_looks <- tbl(l2t_eyetracking, "Looks") %>% 
  select(TrialID, Time, GazeByImageAOI) %>% 
  collect(n = Inf) %>% 
  inner_join(rwl_trials)

rwl_looks <- rwl_looks %>% 
  inner_join(blocks_to_keep) 

rwl_looks <- rwl_looks %>% 
    select(Study, ResearchID, BlockDialect, Block_Age,
         BlockID, ChildID:CImplant, TrialID, TrialNo, Time, GazeByImageAOI)
```


## Work with the gaze data

First peek at the data.


```{r}
library(lookr)
library(ggplot2)

rwl_looks <- rwl_looks %>% 
  mutate(Dialect = ifelse(AAE, "AAE", "MAE"), 
         BlockDialect = ifelse(BlockDialect == "AAE", "AAE", "MAE"),
         HearsNativeDialect = Dialect == BlockDialect)

participants_to_drop <- rwl_looks %>% 
  filter(between(Time, 0, 2005)) %>% 
  AggregateLooks(BlockID + ResearchID ~ GazeByImageAOI) %>%
  tibble::as_tibble() %>% 
  filter(PropNA > .5) %>% 
  select(ResearchID)

trials_to_drop  <- rwl_looks %>% 
  anti_join(participants_to_drop) %>% 
  filter(between(Time, 0, 2005)) %>%
  AggregateLooks(TrialID + ResearchID ~ GazeByImageAOI) %>% 
  tibble::as_tibble() %>% 
  filter(PropNA > .5) %>% 
  select(TrialID)


looks <- rwl_looks %>%
  anti_join(participants_to_drop) %>% 
  anti_join(trials_to_drop) %>% 
  filter(between(Time, -505, 2005)) %>% 
  AggregateLooks(Study + Dialect + BlockDialect + HearsNativeDialect + ResearchID + Time ~ GazeByImageAOI) %>% 
  tibble::as_tibble() %>% 
  mutate(Looks_Images = Target + Others,
       Prop_Target = Target / Looks_Images,
       Prop_PhonologicalFoil = PhonologicalFoil / Looks_Images,
       Prop_SemanticFoil = SemanticFoil / Looks_Images,
       Prop_Unrelated = Unrelated / Looks_Images)






ggplot(looks) + 
  aes(x = Time, y = Proportion) +   
  geom_hline(yintercept = .25, size = 2, color = "white") + 
  stat_summary()

ggplot(looks) + 
  aes(x = Time, y = Proportion, color = HearsNativeDialect) + 
  geom_hline(yintercept = .25, size = 2, color = "white") + 
  stat_summary()

ggplot(looks) + 
  aes(x = Time, y = Proportion, color = HearsNativeDialect) + 
  geom_hline(yintercept = .25, size = 2, color = "white") + 
  stat_summary() + 
  facet_wrap("Dialect") + 
  xlim(0, 2000)


by_dialect_acc <- rwl_looks %>%
  anti_join(participants_to_drop) %>% 
  anti_join(trials_to_drop) %>% 
  filter(between(Time, 0, 2005)) %>% 
  AggregateLooks(Study + Dialect + BlockDialect + HearsNativeDialect + ResearchID ~ GazeByImageAOI) %>% 
  tibble::as_tibble() %>% 
  select(Study, ResearchID, HearsNativeDialect, Proportion) %>% 
  tidyr::spread(HearsNativeDialect, Proportion) %>% 
  mutate(NativeAdvantage = `TRUE` - `FALSE`) %>% 
  arrange(desc(NativeAdvantage)

bot6 <- by_dialect_acc$ResearchID %>% head(6)
top6 <- by_dialect_acc$ResearchID %>% tail(6)

ggplot(looks %>% filter(ResearchID %in% bot6)) + 
  aes(x = Time, y = Proportion, color = HearsNativeDialect) +
  geom_hline(yintercept = .25, size = 2, color = "white") +
  geom_line() +
  facet_wrap("ResearchID") +
  xlim(0, 2000)

ggplot(looks %>% filter(ResearchID %in% top6)) + 
  aes(x = Time, y = Proportion, color = HearsNativeDialect) +
  geom_hline(yintercept = .25, size = 2, color = "white") +
  geom_line() +
  facet_wrap("ResearchID") +
  xlim(0, 2000)




df_looks_to_aois <- looks %>% 
  select(Study, Dialect, HearsNativeDialect, ResearchID, Time, starts_with("Prop_")) %>% 
  tidyr::gather(AOI, Proportion, -Study, -ResearchID, -Time, -HearsNativeDialect, -Dialect) %>% 
  mutate(AOI = AOI %>% 
           stringr::str_replace("Prop_", "") %>% 
           stringr::str_replace("Foil", "")) 

df_looks_to_aois$AOI <- factor(
  df_looks_to_aois$AOI, 
  levels = c("Target", "Phonological", "Semantic", "Unrelated"))

curr_labs <- labs(
  x = "Time after target onset (ms.)", 
  y = "Proportion of looks", 
  color = "Image") 

p_theme <- theme_grey(base_size = 11) + 
  theme(legend.position = "bottom")

ggplot(df_looks_to_aois) + 
  aes(x = Time, y = Proportion, shape = AOI, color = HearsNativeDialect) + 
  geom_hline(yintercept = .25, size = 2, color = "white") + 
  stat_summary(fun.y = mean, geom = "line") + 
  facet_grid(Dialect ~ AOI) +
  p_theme







```














